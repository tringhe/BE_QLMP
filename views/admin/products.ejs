<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="h3 mb-0 d-flex align-items-center">
            <div class="bg-primary text-white rounded-3 p-2 me-3"
                style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-box"></i>
            </div>
            Product Management
        </h2>
        <p class="text-muted mb-0 mt-1">Manage all products in your store</p>
    </div>
    <div class="d-flex gap-2">
        <a href="/admin/products/export" class="text-secondary text-decoration-none fw-medium d-inline-flex align-items-center">
            <i class="fas fa-download me-2"></i>
            Export Excel
        </a>
        <a href="/admin/products/add" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>
            Add New Product
        </a>
    </div>
</div>

<!-- Filters Section -->
<div class="card card-custom mb-4">
    <div class="card-body">
        <form method="GET" action="/admin/products" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">
                    <i class="fas fa-search me-2 text-muted"></i>
                    Search
                </label>
                <input type="text" class="form-control" name="search" placeholder="Product name, brand..."
                    value="<%= req.query.search || '' %>">
            </div>
            <div class="col-md-3">
                <label class="form-label">
                    <i class="fas fa-tags me-2 text-muted"></i>
                    Category
                </label>
                <select class="form-select" name="category">
                    <option value="">All Categories</option>
                    <% categories.forEach(category=> { %>
                        <option value="<%= category %>" <%=req.query.category===category ? 'selected' : '' %>>
                            <%= category %>
                        </option>
                        <% }) %>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">
                    <i class="fas fa-copyright me-2 text-muted"></i>
                    Thương hiệu
                </label>
                <select class="form-select" name="brand">
                    <option value="">Tất cả thương hiệu</option>
                    <% brands.forEach(brand=> { %>
                        <option value="<%= brand %>" <%=req.query.brand===brand ? 'selected' : '' %>>
                            <%= brand %>
                        </option>
                        <% }) %>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search"></i>
                    <span class="d-none d-sm-inline ms-1">Tìm</span>
                </button>
                <a href="/admin/products" class="btn btn-outline-secondary">
                    <i class="fas fa-refresh"></i>
                </a>
            </div>
        </form>
    </div>
</div><!-- Products Table -->
<div class="card card-custom">
    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
        <div>
            <h5 class="card-title mb-0">
                Danh sách sản phẩm
            </h5>
            <small class="text-muted">
                <span class="fw-bold text-primary">
                    <%= products.length %>
                </span> sản phẩm
            </small>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-danger" onclick="deleteSelected()">
                <i class="fas fa-trash me-1"></i>
                Xóa đã chọn
            </button>
            <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-secondary active" onclick="toggleView('table')" id="tableViewBtn">
                    <i class="fas fa-list"></i>
                    <span class="d-none d-sm-inline ms-1">Bảng</span>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleView('grid')" id="gridViewBtn">
                    <i class="fas fa-th-large"></i>
                    <span class="d-none d-sm-inline ms-1">Lưới</span>
                </button>
            </div>
        </div>
    </div>

    <div class="card-body p-0">
        <!-- Table View -->
        <div id="tableView" class="table-responsive">
            <% if (products.length===0) { %>
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-box-open fa-4x text-muted opacity-50"></i>
                    </div>
                    <h5 class="text-muted">Chưa có sản phẩm nào</h5>
                    <p class="text-muted mb-4">Hãy thêm sản phẩm đầu tiên của bạn</p>
                    <a href="/admin/products/add" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>
                        Thêm sản phẩm mới
                    </a>
                </div>
                <% } else { %>
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="50">
                                    <input type="checkbox" class="form-check-input" id="selectAll"
                                        onchange="toggleSelectAll()">
                                </th>
                                <th>Sản phẩm</th>
                                <th>Danh mục</th>
                                <th>Thương hiệu</th>
                                <th>Giá bán</th>
                                <th>Tồn kho</th>
                                <th>Trạng thái</th>
                                <th width="150">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% products.forEach(product=> { %>
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input product-checkbox"
                                            value="<%= product._id %>" onchange="updateSelectAll()">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="<%= ((product.images && product.images[0]) ? product.images[0] : (Array.isArray(product.image) && product.image[0]) ? product.image[0] : (typeof product.image === 'string' ? product.image : '/static/images/no-image.jpg')).replace(/^\/public/, '/static') %>"
                                                alt="<%= product.name %>" class="rounded me-3 product-thumb"
                                                style="width: 60px; height: 60px; object-fit: cover;">
                                            <div>
                                                <h6 class="mb-1 fw-semibold">
                                                    <%= product.name %>
                                                </h6>
                                                <small class="text-muted">ID: <%= product._id.toString().slice(-8) %>
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark border">
                                            <%= product.category %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="fw-medium text-muted">
                                            <%= product.brand %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="fw-bold text-success">
                                            <%= new Intl.NumberFormat('vi-VN', { style: 'currency' , currency: 'VND'
                                                }).format(product.price) %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (product.stock> 10) { %>
                                            <span class="badge bg-success">
                                                <%= product.stock %>
                                            </span>
                                            <% } else if (product.stock> 0) { %>
                                                <span class="badge bg-warning">
                                                    <%= product.stock %>
                                                </span>
                                                <% } else { %>
                                                    <span class="badge bg-danger">Hết hàng</span>
                                                    <% } %>
                                    </td>
                                    <td>
                                        <% if (product.status==='active' ) { %>
                                            <span class="badge bg-success">Đang bán</span>
                                            <% } else { %>
                                                <span class="badge bg-secondary">Tạm dừng</span>
                                                <% } %>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="/admin/products/edit/<%= product._id %>"
                                                class="btn btn-sm btn-outline-primary" title="Chỉnh sửa">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger"
                                                onclick="deleteProduct('<%= product._id %>', '<%= product.name %>')"
                                                title="Xóa">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                    <% } %>
        </div>

        <!-- Grid View -->
        <div id="gridView" class="d-none p-4">
            <div class="row g-4">
                <% products.forEach(product=> { %>
                    <div class="col-lg-3 col-md-4 col-sm-6">
                        <div class="card h-100 product-card border-0 shadow-sm">
                            <div class="position-relative">
                                <img src="<%= ((product.images && product.images[0]) ? product.images[0] : (Array.isArray(product.image) && product.image[0]) ? product.image[0] : (typeof product.image === 'string' ? product.image : '/static/images/no-image.jpg')).replace(/^\/public/, '/static') %>"
                                    alt="<%= product.name %>" class="card-img-top product-grid-img"
                                    style="height: 200px; object-fit: cover;">
                                <div class="position-absolute top-0 start-0 m-2">
                                    <input type="checkbox" class="form-check-input product-checkbox"
                                        value="<%= product._id %>">
                                </div>
                                <div class="position-absolute top-0 end-0 m-2">
                                    <% if (product.status==='active' ) { %>
                                        <span class="badge bg-success">Đang bán</span>
                                        <% } else { %>
                                            <span class="badge bg-secondary">Tạm dừng</span>
                                            <% } %>
                                </div>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title fw-semibold">
                                    <%= product.name %>
                                </h6>
                                <p class="text-muted small mb-2">
                                    <%= product.category %> • <%= product.brand %>
                                </p>
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold text-success">
                                            <%= new Intl.NumberFormat('vi-VN', { style: 'currency' , currency: 'VND'
                                                }).format(product.price) %>
                                        </span>
                                        <small class="text-muted">Kho: <%= product.stock %></small>
                                    </div>
                                    <div class="btn-group w-100" role="group">
                                        <a href="/admin/products/edit/<%= product._id %>"
                                            class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger"
                                            onclick="deleteProduct('<%= product._id %>', '<%= product.name %>')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% }) %>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedProducts = [];

    function toggleView(view) {
        const tableView = document.getElementById('tableView');
        const gridView = document.getElementById('gridView');
        const tableBtn = document.getElementById('tableViewBtn');
        const gridBtn = document.getElementById('gridViewBtn');

        // Remove active class from all buttons
        tableBtn.classList.remove('active');
        gridBtn.classList.remove('active');

        if (view === 'table') {
            tableView.classList.remove('d-none');
            gridView.classList.add('d-none');
            tableBtn.classList.add('active');
        } else {
            tableView.classList.add('d-none');
            gridView.classList.remove('d-none');
            gridBtn.classList.add('active');
        }
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.product-checkbox');

        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });

        updateSelectedProducts();
    }

    function updateSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.product-checkbox');
        const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');

        if (selectAll) {
            selectAll.checked = checkboxes.length === checkedBoxes.length && checkboxes.length > 0;
            selectAll.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < checkboxes.length;
        }

        updateSelectedProducts();
    }

    function updateSelectedProducts() {
        const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
        selectedProducts = Array.from(checkedBoxes).map(cb => cb.value);
    }

    function deleteProduct(productId, productName) {
        if (confirm(`Bạn có chắc chắn muốn xóa sản phẩm "${productName}"?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/products/delete/${productId}`;

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_method';
            csrfInput.value = 'DELETE';
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        }
    }

    function deleteSelected() {
        if (selectedProducts.length === 0) {
            alert('Vui lòng chọn ít nhất một sản phẩm để xóa');
            return;
        }

        if (confirm(`Bạn có chắc chắn muốn xóa ${selectedProducts.length} sản phẩm đã chọn?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/products/delete-multiple';

            selectedProducts.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'productIds';
                input.value = id;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectAll);
        });

        // Add hover effects to cards
        const cards = document.querySelectorAll('.product-card');
        cards.forEach(card => {
            card.addEventListener('mouseenter', function () {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
            });
            card.addEventListener('mouseleave', function () {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
            });
        });
    });
</script>

<style>
    .product-card {
        transition: all 0.3s ease;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Thumbnail helpers */
    .product-thumb {
        width: 60px;
        height: 60px;
        object-fit: cover;
        display: inline-block;
    }

    .product-grid-img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }

    .btn-group .btn {
        border-radius: 8px;
    }

    .btn-group .btn:not(:last-child) {
        margin-right: 4px;
    }

    .card-custom {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.5em 0.8em;
    }
</style>